#!/bin/bash
set -euo pipefail
fn=${1?"need file name"}

CC=g++
if [ "$(uname -s)" = "Darwin" ]; then
  CC=g++-11
fi

ARGS=''
DEBUG=0
if [ $# = 1 ] || [ $2 = true ] || [ $2 = 1 ]; then
  DEBUG=1
  ARGS="${ARGS:+$ARGS }-DDEBUG"
  # if ! [[ "$ARGS" =~ "-O" ]]; then
  #     ARGS="${ARGS:+$ARGS }-Og"
  # fi
fi
if [ $# -ge 3 ]; then
  ARGS="${ARGS:+$ARGS }$(echo $* | cut -d ' ' -f 3-)"
fi
if ! [[ "$ARGS" =~ "-std=" ]]; then
  ARGS="${ARGS:+$ARGS }-std=c++17"
fi

file_name="$(sha1sum "$1" | awk '{print $1}')-$(echo $ARGS | sha1sum | awk '{print $1}').out"
dir='/tmp/run_c'
mkdir -p $dir
file="$dir/$file_name"

INCLUDE="-I$HOME/project/tools/include -I$HOME/project/tools/boost_1_73_0 -I/usr/local/include"

>&2 echo \$ARGS=\'"$ARGS"\'
>&2 echo $file
if [ -e "$file" ]; then
  time >&2 echo "cached file exist!"
else
  set -eux
  time $CC $ARGS $INCLUDE -Wall -Wextra -Wshadow -Wconversion "$fn" -o "$file"
fi
>&2 echo 
time "$file"
